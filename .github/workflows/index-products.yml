name: Batch Index Products to Vector Search

on:
  workflow_dispatch:
    inputs:
      complete_overwrite:
        description: 'Complete overwrite of index (true) or delta update (false)'
        required: true
        default: 'true'
        type: boolean
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION || 'us-central1' }}
  SERVICE_NAME: cartiq-backend
  GCS_BUCKET: cartiq-indexing-data

jobs:
  batch-index-products:
    name: Batch Index Products to Vertex AI Vector Search
    runs-on: ubuntu-latest
    environment: prod
    timeout-minutes: 180  # 3 hour timeout for large catalogs

    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Get Cloud Run Service URL
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Cloud Run Service URL: $SERVICE_URL"

      - name: Generate Timestamp
        id: timestamp
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H-%M-%S")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "Batch ID: $TIMESTAMP"

      - name: Check Batch Indexing Health
        run: |
          echo "Checking batch indexing service health..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "${{ steps.get-url.outputs.service_url }}/api/internal/indexing/batch/health" \
            -H "X-Internal-Api-Key: ${{ secrets.INTERNAL_API_KEY }}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Health Check Response: $BODY"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Health check failed with status $HTTP_CODE"
            exit 1
          fi

      - name: Step 1 - Export Products to GCS
        id: export
        run: |
          echo "Exporting products to GCS..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${{ steps.get-url.outputs.service_url }}/api/internal/indexing/batch/export?timestamp=${{ steps.timestamp.outputs.timestamp }}" \
            -H "X-Internal-Api-Key: ${{ secrets.INTERNAL_API_KEY }}" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response Code: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            INPUT_GCS_URI=$(echo "$BODY" | jq -r '.inputGcsUri')
            PRODUCT_COUNT=$(echo "$BODY" | jq -r '.productCount')
            echo "input_gcs_uri=$INPUT_GCS_URI" >> $GITHUB_OUTPUT
            echo "product_count=$PRODUCT_COUNT" >> $GITHUB_OUTPUT
            echo "Exported $PRODUCT_COUNT products to: $INPUT_GCS_URI"
          else
            echo "Export failed"
            exit 1
          fi

      - name: Step 2 - Submit Batch Embedding Job
        id: embed
        run: |
          echo "Submitting batch embedding job..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${{ steps.get-url.outputs.service_url }}/api/internal/indexing/batch/embed?inputGcsUri=${{ steps.export.outputs.input_gcs_uri }}&timestamp=${{ steps.timestamp.outputs.timestamp }}" \
            -H "X-Internal-Api-Key: ${{ secrets.INTERNAL_API_KEY }}" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response Code: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            JOB_NAME=$(echo "$BODY" | jq -r '.jobName')
            echo "job_name=$JOB_NAME" >> $GITHUB_OUTPUT
            echo "Batch job submitted: $JOB_NAME"
          else
            echo "Failed to submit embedding job"
            exit 1
          fi

      - name: Step 2b - Wait for Embedding Job to Complete
        id: wait-embed
        run: |
          echo "Waiting for batch embedding job to complete..."
          echo "Job: ${{ steps.embed.outputs.job_name }}"

          MAX_ATTEMPTS=120  # 2 hours at 1 minute intervals
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))

            RESPONSE=$(curl -s \
              "${{ steps.get-url.outputs.service_url }}/api/internal/indexing/batch/embed/status?jobName=${{ steps.embed.outputs.job_name }}" \
              -H "X-Internal-Api-Key: ${{ secrets.INTERNAL_API_KEY }}")

            STATE=$(echo "$RESPONSE" | jq -r '.state')
            OUTPUT_URI=$(echo "$RESPONSE" | jq -r '.outputUri')

            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - State: $STATE"

            if [ "$STATE" = "JOB_STATE_SUCCEEDED" ]; then
              echo "Embedding job completed successfully!"
              echo "output_uri=$OUTPUT_URI" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATE" = "JOB_STATE_FAILED" ] || [ "$STATE" = "JOB_STATE_CANCELLED" ]; then
              echo "Embedding job failed with state: $STATE"
              exit 1
            fi

            # Wait 1 minute between checks
            sleep 60
          done

          echo "Timeout waiting for embedding job"
          exit 1

      - name: Step 3 - Transform Embeddings to Vector Search Format
        id: transform
        run: |
          echo "Transforming embeddings to Vector Search format..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${{ steps.get-url.outputs.service_url }}/api/internal/indexing/batch/transform?timestamp=${{ steps.timestamp.outputs.timestamp }}" \
            -H "X-Internal-Api-Key: ${{ secrets.INTERNAL_API_KEY }}" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response Code: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            TRANSFORMED=$(echo "$BODY" | jq -r '.transformedCount')
            echo "transformed_count=$TRANSFORMED" >> $GITHUB_OUTPUT
            echo "Transformed $TRANSFORMED embeddings"
          else
            echo "Transform failed"
            exit 1
          fi

      - name: Step 4 - Start Vector Search Index Update
        id: update-index
        run: |
          echo "Starting Vector Search index update..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${{ steps.get-url.outputs.service_url }}/api/internal/indexing/batch/update-index?timestamp=${{ steps.timestamp.outputs.timestamp }}&completeOverwrite=${{ inputs.complete_overwrite || 'true' }}" \
            -H "X-Internal-Api-Key: ${{ secrets.INTERNAL_API_KEY }}" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response Code: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            OPERATION_NAME=$(echo "$BODY" | jq -r '.operationName')
            echo "operation_name=$OPERATION_NAME" >> $GITHUB_OUTPUT
            echo "Index update started: $OPERATION_NAME"
          else
            echo "Failed to start index update"
            exit 1
          fi

      - name: Step 4b - Wait for Index Update to Complete
        id: wait-index
        run: |
          echo "Waiting for index update to complete..."
          echo "Operation: ${{ steps.update-index.outputs.operation_name }}"

          MAX_ATTEMPTS=60  # 1 hour at 1 minute intervals
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))

            RESPONSE=$(curl -s \
              "${{ steps.get-url.outputs.service_url }}/api/internal/indexing/batch/update-index/status?operationName=${{ steps.update-index.outputs.operation_name }}" \
              -H "X-Internal-Api-Key: ${{ secrets.INTERNAL_API_KEY }}")

            STATE=$(echo "$RESPONSE" | jq -r '.state')
            DONE=$(echo "$RESPONSE" | jq -r '.done')

            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - State: $STATE, Done: $DONE"

            if [ "$STATE" = "SUCCEEDED" ]; then
              echo "Index update completed successfully!"
              echo "index_name=${{ steps.update-index.outputs.operation_name }}" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATE" = "FAILED" ]; then
              ERROR=$(echo "$RESPONSE" | jq -r '.error // "Unknown error"')
              echo "Index update failed: $ERROR"
              exit 1
            fi

            # Wait 1 minute between checks
            sleep 60
          done

          echo "Timeout waiting for index update"
          exit 1

      - name: Summary
        if: always()
        run: |
          echo "## Batch Product Indexing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | - | ${{ steps.timestamp.outputs.timestamp }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Export | ${{ steps.export.outcome }} | ${{ steps.export.outputs.product_count }} products â†’ ${{ steps.export.outputs.input_gcs_uri }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Embed Job | ${{ steps.embed.outcome }} | ${{ steps.embed.outputs.job_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Wait for Embed | ${{ steps.wait-embed.outcome }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Transform | ${{ steps.transform.outcome }} | ${{ steps.transform.outputs.transformed_count }} vectors |" >> $GITHUB_STEP_SUMMARY
          echo "| Start Index Update | ${{ steps.update-index.outcome }} | ${{ steps.update-index.outputs.operation_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Wait for Index | ${{ steps.wait-index.outcome }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Complete Overwrite**: ${{ inputs.complete_overwrite || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service URL**: ${{ steps.get-url.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GCS Bucket**: ${{ env.GCS_BUCKET }}" >> $GITHUB_STEP_SUMMARY
